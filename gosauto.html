<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GOS自動入力シミュレーター</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap');
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #351715;
            color: #3f3f46;
        }
        .main-container {
            max-width: 800px;
            margin: 2rem auto;
            background-color: #F1EFE3;
            border-radius: 1.5rem;
            padding: 2rem 2.5rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        .stat-input { @apply block w-full py-2 px-3 border border-stone-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-amber-600 focus:border-amber-600 sm:text-sm; }
        .stat-label { @apply text-sm font-medium text-stone-600; }
        .back-button {
            display: inline-flex; align-items: center; padding: 0.5rem 1rem;
            background-color: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2);
            color: #f3f4f6; border-radius: 9999px; transition: background-color 0.2s; text-decoration: none; margin-bottom: 1rem;
        }
        .back-button:hover { background-color: rgba(255, 255, 255, 0.2); }
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #ca8a04;
            border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="p-4">
        <a href="https://sulebox.github.io/mikoguild/rank.html" class="back-button">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            ランキングへ戻る
        </a>
    </div>

    <div class="main-container">
        <h1 class="text-3xl md:text-4xl font-bold text-center text-stone-800 mb-6">GOS自動入力シミュレーター</h1>
        
        <!-- Image Upload Section -->
        <div class="mb-6 p-6 border-2 border-dashed border-stone-300 rounded-xl text-center">
             <label for="imageUpload" class="cursor-pointer inline-flex items-center bg-white text-stone-700 font-bold py-3 px-6 rounded-full shadow-md hover:bg-stone-100 transition">
                <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" /></svg>
                スクリーンショットを選択
            </label>
            <input type="file" id="imageUpload" class="hidden" accept="image/*">
            <div id="imagePreviewContainer" class="mt-4 hidden">
                <p class="text-sm text-stone-500 mb-2">プレビュー:</p>
                <img id="imagePreview" class="max-w-xs mx-auto rounded-lg shadow-md">
            </div>
             <button id="analyzeButton" class="hidden mt-4 bg-amber-600 text-white font-bold py-3 px-8 rounded-full shadow-md hover:bg-amber-700 transition-transform transform hover:-translate-y-0.5 inline-flex items-center">
                <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z" /></svg>
                数値を自動入力
            </button>
             <div id="loader" class="hidden mt-4 mx-auto loader"></div>
             <p id="errorMessage" class="hidden mt-4 text-red-600"></p>
        </div>


        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 items-center border-t border-b border-stone-200 py-6">
             <div class="md:col-span-1">
                <label for="calcType" class="stat-label">職業種別:</label>
                <select id="calcType" class="mt-1 block w-full py-2 px-3 border border-stone-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-amber-600 focus:border-amber-600 sm:text-sm">
                    <option value="物理">物理</option>
                    <option value="魔法">魔法</option>
                </select>
            </div>
             <div class="md:col-span-2 text-center md:text-right">
                <span class="text-xl font-medium text-stone-700">あなたのGOSは:</span>
                <span id="gosResult" class="text-4xl md:text-5xl font-bold text-amber-700 ml-2">0</span>
            </div>
        </div>
        
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-8 gap-y-4">
             <div class="grid grid-cols-3 gap-2 items-center"><label for="hp" class="stat-label col-span-1 text-right pr-2">HP:</label><input type="number" id="hp" class="stat-input col-span-2" placeholder="x1"></div>
             <div class="grid grid-cols-3 gap-2 items-center"><label for="mp" class="stat-label col-span-1 text-right pr-2">MP:</label><input type="number" id="mp" class="stat-input col-span-2" placeholder="x1"></div>
             <div class="grid grid-cols-3 gap-2 items-center"><label for="attack" class="stat-label col-span-1 text-right pr-2">攻撃:</label><input type="number" id="attack" class="stat-input col-span-2" placeholder="x0.5（補正）"></div>
             <div class="grid grid-cols-3 gap-2 items-center"><label for="defense" class="stat-label col-span-1 text-right pr-2">防御:</label><input type="number" id="defense" class="stat-input col-span-2" placeholder="x1"></div>
             <div class="grid grid-cols-3 gap-2 items-center"><label for="magicAttack" class="stat-label col-span-1 text-right pr-2">魔法攻撃:</label><input type="number" id="magicAttack" class="stat-input col-span-2" placeholder="x0.2（補正）"></div>
             <div class="grid grid-cols-3 gap-2 items-center"><label for="castingSpeed" class="stat-label col-span-1 text-right pr-2">詠唱速度:</label><input type="number" id="castingSpeed" class="stat-input col-span-2" placeholder="魔x0.9 / 物x0.5"></div>
             <div class="grid grid-cols-3 gap-2 items-center"><label for="strength" class="stat-label col-span-1 text-right pr-2">腕力:</label><input type="number" id="strength" class="stat-input col-span-2" placeholder="x1"></div>
             <div class="grid grid-cols-3 gap-2 items-center"><label for="vitality" class="stat-label col-span-1 text-right pr-2">体力:</label><input type="number" id="vitality" class="stat-input col-span-2" placeholder="x1"></div>
             <div class="grid grid-cols-3 gap-2 items-center"><label for="speed" class="stat-label col-span-1 text-right pr-2">速さ:</label><input type="number" id="speed" class="stat-input col-span-2" placeholder="x1"></div>
             <div class="grid grid-cols-3 gap-2 items-center"><label for="intelligence" class="stat-label col-span-1 text-right pr-2">知力:</label><input type="number" id="intelligence" class="stat-input col-span-2" placeholder="x1"></div>
             <div class="grid grid-cols-3 gap-2 items-center"><label for="dexterity" class="stat-label col-span-1 text-right pr-2">器用:</label><input type="number" id="dexterity" class="stat-input col-span-2" placeholder="x1"></div>
             <div class="grid grid-cols-3 gap-2 items-center"><label for="mind" class="stat-label col-span-1 text-right pr-2">精神:</label><input type="number" id="mind" class="stat-input col-span-2" placeholder="x1"></div>
             <div class="grid grid-cols-3 gap-2 items-center"><label for="maxPhysicalCritMultiplier" class="stat-label col-span-1 text-right pr-2">Max物ｸﾘ倍:</label><input type="number" id="maxPhysicalCritMultiplier" class="stat-input col-span-2" placeholder="ｸﾘ率x0.33"></div>
             <div class="grid grid-cols-3 gap-2 items-center"><label for="maxMagicalCritMultiplier" class="stat-label col-span-1 text-right pr-2">Max魔ｸﾘ倍:</label><input type="number" id="maxMagicalCritMultiplier" class="stat-input col-span-2" placeholder="ｸﾘ率x0.33"></div>
        </div>

        <div class="mt-8 text-center">
            <button id="resetButton" class="bg-white text-stone-700 font-bold py-3 px-8 rounded-full shadow-md hover:bg-stone-100 transition-transform transform hover:-translate-y-0.5 inline-flex items-center">
                <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0011.664 0l3.18-3.185m-7.923-8.25v4.992m0 0h-4.992m4.992 0l-3.182-3.182a8.25 8.25 0 00-11.664 0l-3.18 3.185" /></svg>
                リセット
            </button>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const imageUploadInput = document.getElementById('imageUpload');
        const imagePreviewContainer = document.getElementById('imagePreviewContainer');
        const imagePreview = document.getElementById('imagePreview');
        const analyzeButton = document.getElementById('analyzeButton');
        const loader = document.getElementById('loader');
        const errorMessage = document.getElementById('errorMessage');

        const calcTypeSelect = document.getElementById('calcType');
        const gosResultSpan = document.getElementById('gosResult');
        const resetButton = document.getElementById('resetButton');
        const statInputIds = [
            'hp', 'mp', 'attack', 'defense', 'magicAttack', 'castingSpeed',
            'strength', 'vitality', 'speed', 'intelligence', 'dexterity', 'mind',
            'maxPhysicalCritMultiplier', 'maxMagicalCritMultiplier'
        ];
        const statInputs = statInputIds.reduce((acc, id) => ({ ...acc, [id]: document.getElementById(id) }), {});

        // --- Event Listeners ---
        imageUploadInput.addEventListener('change', handleImageSelect);
        analyzeButton.addEventListener('click', analyzeImage);
        resetButton.addEventListener('click', resetAll);
        calcTypeSelect.addEventListener('change', calculateGOS);
        statInputIds.forEach(id => statInputs[id].addEventListener('input', calculateGOS));

        // --- Functions ---
        function handleImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = e => {
                imagePreview.src = e.target.result;
                imagePreviewContainer.classList.remove('hidden');
                analyzeButton.classList.remove('hidden');
                errorMessage.classList.add('hidden');
            };
            reader.readAsDataURL(file);
        }

        async function analyzeImage() {
            if (!imagePreview.src) {
                showError("先に画像を選択してください。");
                return;
            }
            
            setLoading(true);

            const base64ImageData = imagePreview.src.split(',')[1];
            
            const schema = {
                type: "OBJECT",
                properties: {
                    hp: { type: "NUMBER", description: "HPの数値" },
                    mp: { type: "NUMBER", description: "MPの数値" },
                    attack: { type: "NUMBER", description: "攻撃の数値" },
                    defense: { type: "NUMBER", description: "防御の数値" },
                    magicAttack: { type: "NUMBER", description: "魔法攻撃の数値" },
                    castingSpeed: { type: "NUMBER", description: "詠唱速度の数値" },
                    strength: { type: "NUMBER", description: "腕力の数値" },
                    vitality: { type: "NUMBER", description: "体力の数値" },
                    speed: { type: "NUMBER", description: "速さの数値" },
                    intelligence: { type: "NUMBER", description: "知力の数値" },
                    dexterity: { type: "NUMBER", description: "器用の数値" },
                    mind: { type: "NUMBER", description: "精神の数値" },
                    maxPhysicalCritMultiplier: { type: "NUMBER", description: "物理CRI倍率の最大値(例:30~164なら164)" },
                    maxMagicalCritMultiplier: { type: "NUMBER", description: "魔法CRI倍率の最大値(例:30~114なら114)" }
                },
                required: ["hp", "mp", "attack", "defense", "magicAttack", "castingSpeed", "strength", "vitality", "speed", "intelligence", "dexterity", "mind", "maxPhysicalCritMultiplier", "maxMagicalCritMultiplier"]
            };

            const payload = {
                contents: [{
                    role: "user",
                    parts: [
                        { text: "これはゲーム「元素騎士オンライン」のステータス画面のスクリーンショットです。この画像からステータス情報を抽出してください。物理CRI倍率と魔法CRI倍率については、範囲の中から最大値のみを抽出してください。指定されたJSONスキーマに従って回答してください。" },
                        { inlineData: { mimeType: "image/jpeg", data: base64ImageData } }
                    ]
                }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: schema
                }
            };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    throw new Error(`API error! status: ${response.status}`);
                }
                const result = await response.json();
                
                if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0].text) {
                    const stats = JSON.parse(result.candidates[0].content.parts[0].text);
                    populateFields(stats);
                    calculateGOS();
                } else {
                    throw new Error("APIから有効なデータが返されませんでした。");
                }
            } catch (error) {
                console.error('Error during AI analysis:', error);
                showError("画像の解析に失敗しました。画像の向きや鮮明さを確認して再度お試しください。");
            } finally {
                setLoading(false);
            }
        }
        
        function populateFields(stats) {
            for (const key in stats) {
                if (statInputs[key]) {
                    statInputs[key].value = stats[key];
                }
            }
        }

        function calculateGOS() {
            const getVal = id => parseFloat(statInputs[id].value) || 0;
            const selectedType = calcTypeSelect.value;
            let gos = 0;

            const hp = getVal('hp'), mp = getVal('mp'), attack = getVal('attack'), defense = getVal('defense'),
                  magicAttack = getVal('magicAttack'), castingSpeed = getVal('castingSpeed'),
                  strength = getVal('strength'), vitality = getVal('vitality'), speed = getVal('speed'),
                  intelligence = getVal('intelligence'), dexterity = getVal('dexterity'), mind = getVal('mind'),
                  maxPhysCrit = getVal('maxPhysicalCritMultiplier'), maxMagCrit = getVal('maxMagicalCritMultiplier');

            if (selectedType === "物理") {
                gos = hp + mp +
                      (attack * 0.5) * ((((castingSpeed - 50) / 50 - 1) * 0.5) + 1) * ((((maxPhysCrit - 30) / 2 + 30) * 0.33 + 100) / 100) +
                      defense +
                      (magicAttack * 0.2 + intelligence) * (((maxMagCrit - 30) / 2 * 0.33 + 100) / 100) +
                      strength + vitality + speed + dexterity + mind;
            } else { // 魔法
                gos = hp + mp +
                      (attack * 0.5) * (((maxPhysCrit - 30) / 2 * 0.33 + 100) / 100) +
                      defense +
                      (magicAttack * 0.2 + intelligence) * ((((castingSpeed - 50) / 50 - 1) * 0.9) + 1) * ((((maxMagCrit - 30) / 2 + 30) * 0.33 + 100) / 100) +
                      strength + vitality + speed + dexterity + mind;
            }
            gosResultSpan.textContent = Math.round(gos);
        }

        function resetAll() {
            statInputIds.forEach(id => statInputs[id].value = '');
            calcTypeSelect.value = '物理';
            imagePreview.src = '';
            imagePreviewContainer.classList.add('hidden');
            analyzeButton.classList.add('hidden');
            errorMessage.classList.add('hidden');
            loader.classList.add('hidden');
            imageUploadInput.value = ''; // Reset file input
            calculateGOS();
        }
        
        function setLoading(isLoading) {
            if (isLoading) {
                loader.classList.remove('hidden');
                analyzeButton.classList.add('hidden');
                errorMessage.classList.add('hidden');
            } else {
                loader.classList.add('hidden');
                analyzeButton.classList.remove('hidden');
            }
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        // Initial calculation on page load
        calculateGOS();
    </script>
</body>
</html>