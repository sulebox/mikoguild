<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>防衛戦PT編成ツール</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-main: #F1EFEA;
            --bg-card: #FFFFFF;
            --text-primary: #333333;
            --text-secondary: #8a8a8a;
            --border-color: #D8D8D8;
            --accent-dps: #C9A891;
            --accent-support: #94A3B8;
            --accent-healer: #A3B894;
            --btn-primary-bg: #4A5568;
            --btn-primary-hover: #2D3748;
            --btn-secondary-bg: #A0AEC0;
            --btn-secondary-hover: #718096;
        }

        body {
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-primary);
        }
        .draggable { cursor: move; user-select: none; }
        .drop-zone {
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
            border-radius: 0.5rem;
            border-width: 2px;
            border-style: dashed;
            padding: 0.5rem;
            display: grid;
            gap: 0.5rem;
            align-content: start;
        }
        .drop-zone.drag-over { background-color: #e0f2fe; border-color: #38bdf8; }
        .character-token {
            transition: all 0.2s;
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            text-align: center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .character-token:hover { background-color: #f7fafc; }
        /* Styles for Tap-to-Move */
        .character-token.selected {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
            background-color: #dbeafe;
        }
        .drop-zone.target-active {
            background-color: #e0f2fe;
            border-color: #38bdf8;
        }

        .card-container {
            background-color: var(--bg-card);
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05);
            padding: 1.25rem;
        }
        .btn {
            color: white;
            font-weight: bold;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            transition: background-color 0.3s;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        }
        .btn-primary { background-color: var(--btn-primary-bg); }
        .btn-primary:hover { background-color: var(--btn-primary-hover); }
        .btn-secondary { background-color: var(--btn-secondary-bg); }
        .btn-secondary:hover { background-color: var(--btn-secondary-hover); }
        .input-field {
             border: 1px solid var(--border-color);
             border-radius: 0.5rem;
             padding: 0.75rem;
             background-color: #F8F8F8;
             font-size: 1.25rem;
        }
        #initial-list { grid-template-columns: repeat(2, 1fr); min-height: 400px; max-height: 50vh; overflow-y: auto; }
        #dps { grid-template-columns: repeat(2, 1fr); min-height: 120px; }
        #support, #healer, #absent { grid-template-columns: 1fr; min-height: 120px; }
        .party-member-item.dragging { opacity: 0.4; }
        .party-member-item.drag-over-swap { transform: scale(1.05); background-color: #e0f2fe; }
    </style>
</head>
<body class="antialiased">

    <div class="container mx-auto p-4 max-w-7xl">
        <header class="card-container mb-6">
            <h1 class="text-2xl md:text-3xl font-bold text-center mb-4">防衛戦PT編成ツール</h1>
            <div class="flex flex-col md:flex-row items-center justify-center gap-4 md:gap-6">
                <div class="flex flex-col sm:flex-row items-center gap-4 p-3 bg-gray-50 rounded-xl">
                    <label for="battle-date" class="font-bold text-2xl whitespace-nowrap">決戦日時:</label>
                    <div class="flex items-center gap-2">
                        <input type="date" id="battle-date" class="input-field">
                        <select id="battle-time" class="input-field"></select>
                    </div>
                    <div class="flex items-center gap-2 pl-2 sm:pl-4">
                        <input type="checkbox" id="reserved-checkbox" class="h-5 w-5 rounded border-gray-300 text-indigo-600 shadow-sm focus:ring-indigo-500">
                        <label for="reserved-checkbox" class="font-medium text-gray-700">予約済</label>
                    </div>
                </div>
                <div class="flex flex-col items-center gap-2">
                    <div class="flex items-center gap-4">
                        <button id="organize-button" class="btn btn-primary">PT編成</button>
                        <button id="reset-button" class="btn btn-secondary">リセット</button>
                    </div>
                    <p class="text-xs text-gray-500">※PT編成ボタンはJさんが押すのでみんなは押さないでくださいね</p>
                </div>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div id="initial-list-container" class="card-container lg:col-span-1">
                <h2 class="text-xl font-bold mb-3 text-center border-b pb-2">メンバーリスト</h2>
                <div id="initial-list" class="drop-zone bg-gray-50 border-gray-300"></div>
            </div>

            <div class="lg:col-span-2 grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="card-container md:col-span-2">
                        <h3 class="text-lg font-bold mb-3 text-center" style="color: var(--accent-dps);">火力</h3>
                        <div id="dps" class="drop-zone" style="border-color: var(--accent-dps); background-color: #FAF6F3;"></div>
                    </div>
                    <div class="card-container">
                        <h3 class="text-lg font-bold mb-3 text-center" style="color: var(--accent-support);">シフ/アサ</h3>
                        <div id="support" class="drop-zone" style="border-color: var(--accent-support); background-color: #F3F5F7;"></div>
                    </div>
                    <div class="card-container">
                        <h3 class="text-lg font-bold mb-3 text-center" style="color: var(--accent-healer);">回復</h3>
                        <div id="healer" class="drop-zone" style="border-color: var(--accent-healer); background-color: #F5F7F3;"></div>
                    </div>
                </div>

                <div class="md:col-span-1 flex flex-col">
                    <div class="card-container h-full flex flex-col">
                        <h3 class="text-lg font-bold mb-3 text-center text-gray-500">不参加</h3>
                        <div id="absent" class="drop-zone border-gray-400 bg-gray-100 flex-grow" style="min-height: auto;"></div>
                    </div>
                </div>
            </div>
        </main>
        
        <section id="results-container" class="mt-6 card-container">
            <h2 class="text-xl font-bold mb-4 text-center">編成結果</h2>
            <div id="party-results" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4"></div>
            <div id="error-message" class="text-center text-red-500 font-semibold mt-4 text-lg"></div>
        </section>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAYM0wXCS3lGiSZnkVWseeGHY3BsQWqesk",
            authDomain: "boueisenpj.firebaseapp.com",
            projectId: "boueisenpj",
            storageBucket: "boueisenpj.appspot.com",
            messagingSenderId: "381288462520",
            appId: "1:381288462520:web:76d13ac4d06d9927795c4d"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        const stateDocRef = doc(db, 'artifacts', 'party-planner-v1', 'public', 'data', 'states', 'party-state');
        
        let draggedItem = null;
        let selectedItem = null; // For tap-to-move
        let localUpdate = false;
        const initialCharacters = [
            'jjj', 'ユニコーン', 'あむまん', 'ダン', 'vivi', 'ともどら', 'エマルン', 'にゃんころ大先生', 
            'おとう', 'xbee', 'クゥル', '一夜漬', '秘密のRさん', 'てりり', 'シュール', 'トゥナ', 
            '舞茸', '織姫', 'Aki', '天城ちゃん', 'ぴぴぴ', 'una', 'ロト', '紅蓮アラマ', 
            '佐藤明', 'けんたろう', 'のぞみん', 'くまさん', 'Ying', 'キュード', 'akiyan', 
            'さくちゃん', 'フィール', 'ice', 'RaishiN', 'ニートン', 'ブリンドル', 'キキ', 'クリサム', 'あんこ'
        ];

        const organizeButton = document.getElementById('organize-button');
        const resetButton = document.getElementById('reset-button');
        const partyResults = document.getElementById('party-results');
        const errorMessage = document.getElementById('error-message');
        const dropZones = document.querySelectorAll('.drop-zone');
        const battleTimeSelect = document.getElementById('battle-time');

        document.addEventListener('DOMContentLoaded', async () => {
            await signInAnonymously(auth);
            createCharacterTokens();
            setupEventListeners();
            setupRealtimeListener();
        });

        function createCharacterTokens() {
            initialCharacters.forEach((name) => {
                if (document.getElementById(`char-${name.replace(/\s/g, '-')}`)) return;

                const charEl = document.createElement('div');
                charEl.id = `char-${name.replace(/\s/g, '-')}`;
                charEl.textContent = name;
                charEl.className = 'draggable character-token';
                charEl.draggable = true;
                
                charEl.addEventListener('dragstart', handleDragStart);
                charEl.addEventListener('dragend', handleDragEnd);
                charEl.addEventListener('click', handleTokenClick);

                document.body.appendChild(charEl);
                charEl.style.display = 'none';
            });
        }
        
        async function setupRealtimeListener() {
            onSnapshot(stateDocRef, async (doc) => {
                if (localUpdate) {
                    localUpdate = false;
                    return;
                }
                
                if (!doc.exists() || !doc.data().characters) {
                    await resetStateInFirestore();
                } else {
                    const serverState = doc.data();
                    updateUIFromState(serverState.characters);
                }
            });
        }

        function updateUIFromState(characterPositions) {
            dropZones.forEach(zone => zone.innerHTML = '');
            Object.entries(characterPositions).forEach(([charName, zoneId]) => {
                const charEl = document.getElementById(`char-${charName.replace(/\s/g, '-')}`);
                const zoneEl = document.getElementById(zoneId);
                if (charEl && zoneEl) {
                    charEl.style.display = 'grid';
                    zoneEl.appendChild(charEl);
                }
            });
        }
        
        async function resetStateInFirestore() {
            const initialState = { characters: {} };
            initialCharacters.forEach(name => {
                initialState.characters[name] = 'initial-list';
            });
            localUpdate = true;
            await setDoc(stateDocRef, initialState);
            updateUIFromState(initialState.characters);
        }

        function setupEventListeners() {
            resetButton.addEventListener('click', resetStateInFirestore);

            dropZones.forEach(zone => {
                zone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    if (!zone.contains(draggedItem)) {
                        zone.classList.add('drag-over');
                    }
                });
                zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
                zone.addEventListener('drop', handleDrop);
                zone.addEventListener('click', handleZoneClick); // For tap-to-move
            });
            
            organizeButton.addEventListener('click', handleOrganize);
            initializeTimeSelect();
        }

        async function moveCharacterToZone(characterElement, zoneElement) {
             const charName = characterElement.textContent;
             const newZoneId = zoneElement.id;
             zoneElement.appendChild(characterElement);
             const updatePayload = { [`characters.${charName}`]: newZoneId };
             localUpdate = true;
             await setDoc(stateDocRef, updatePayload, { merge: true });
        }
        
        // --- Drag & Drop Handlers ---
        function handleDragStart(e) {
            if (selectedItem) deselectAll();
            draggedItem = e.target;
            e.target.style.opacity = '0.5';
        }

        function handleDragEnd(e) {
            e.target.style.opacity = '1';
            draggedItem = null;
        }

        async function handleDrop(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            if (draggedItem && draggedItem.parentElement !== this) {
                await moveCharacterToZone(draggedItem, this);
            }
        }

        // --- Tap-to-Move Handlers ---
        function handleTokenClick(e) {
            const clickedItem = e.currentTarget;
            if (selectedItem === clickedItem) {
                deselectAll();
            } else {
                if (selectedItem) selectedItem.classList.remove('selected');
                selectedItem = clickedItem;
                selectedItem.classList.add('selected');
                highlightTargetZones(true);
            }
        }
        
        async function handleZoneClick(e) {
            const clickedZone = e.currentTarget;
            if (selectedItem && selectedItem.parentElement !== clickedZone) {
                await moveCharacterToZone(selectedItem, clickedZone);
                deselectAll();
            }
        }

        function deselectAll() {
            if (selectedItem) {
                selectedItem.classList.remove('selected');
            }
            selectedItem = null;
            highlightTargetZones(false);
        }

        function highlightTargetZones(isActive) {
            dropZones.forEach(zone => {
                if (isActive) {
                    zone.classList.add('target-active');
                } else {
                    zone.classList.remove('target-active');
                }
            });
        }
        
        // --- Main Logic ---
        function handleOrganize() {
            partyResults.innerHTML = '';
            errorMessage.textContent = '';
            const getMembers = (id) => Array.from(document.getElementById(id).children).map(el => el.textContent);
            const healers = getMembers('healer');
            const dps = getMembers('dps');
            const supports = getMembers('support');
            
            const participants = [...healers, ...dps, ...supports];
            if (participants.length === 0) {
                errorMessage.textContent = '参加メンバーがいません。';
                return;
            }

            const totalPlayers = participants.length;
            const numParties = Math.ceil(totalPlayers / 4);

            if (healers.length < numParties) {
                errorMessage.textContent = `パーティ数(${numParties})に対し回復役(${healers.length}人)が足りません。`;
                return;
            }
            
            const shuffle = (array) => {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            };

            let parties = Array.from({ length: numParties }, () => []);
            let availableHealers = shuffle([...healers]);
            let availableSupports = shuffle([...supports]);

            for (let i = 0; i < numParties; i++) {
                if(availableHealers.length > 0) parties[i].push({name: availableHealers.pop(), role: 'healer'});
            }
            for (let i = 0; i < numParties; i++) {
                if(availableSupports.length > 0) parties[i].push({ name: availableSupports.pop(), role: 'support' });
            }
            
            let remainingPlayers = [
                ...availableHealers.map(name => ({name, role: 'healer'})),
                ...availableSupports.map(name => ({name, role: 'support'})),
                ...shuffle(dps).map(name => ({name, role: 'dps'}))
            ];
            remainingPlayers = shuffle(remainingPlayers);

            let playerPool = [...remainingPlayers];
            while(playerPool.length > 0) {
                for(let i = 0; i < numParties; i++) {
                    if (playerPool.length === 0) break;
                    if (parties[i].length < 4) {
                        parties[i].push(playerPool.shift());
                    }
                }
            }
            displayParties(parties);
        }

        function displayParties(parties) {
            partyResults.innerHTML = '';
            const roleOrder = { 'dps': 1, 'support': 2, 'healer': 3 };

            parties.forEach((party, index) => {
                const partyCard = document.createElement('div');
                partyCard.className = 'card-container bg-gray-50 border border-gray-200 p-3';
                const title = document.createElement('h4');
                title.className = 'font-bold text-md mb-2 text-center';
                title.textContent = `Party ${index + 1}`;
                partyCard.appendChild(title);
                const memberList = document.createElement('ul');
                memberList.className = 'space-y-1.5';
                
                party.sort((a, b) => (roleOrder[a.role] || 99) - (roleOrder[b.role] || 99));
                
                party.forEach(member => {
                    const listItem = document.createElement('li');
                    let roleStyle = '';
                    switch (member.role) {
                        case 'healer': roleStyle = 'color: var(--accent-healer); font-weight: 600; border-color: var(--accent-healer);'; break;
                        case 'dps': roleStyle = 'color: var(--accent-dps); border-color: var(--accent-dps);'; break;
                        case 'support': roleStyle = 'color: var(--accent-support); border-color: var(--accent-support);'; break;
                    }
                    listItem.className = `party-member-item p-1.5 bg-white rounded-md text-center border-l-4 text-sm`;
                    listItem.style.cssText = roleStyle;
                    listItem.textContent = member.name;
                    listItem.draggable = true;
                    listItem.dataset.role = member.role;
                    memberList.appendChild(listItem);
                });
                partyCard.appendChild(memberList);
                partyResults.appendChild(partyCard);
            });
            addResultSwapListeners();
        }

        let draggedResultItem = null;

        function addResultSwapListeners() {
            const items = document.querySelectorAll('.party-member-item');
            items.forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    draggedResultItem = e.target;
                    e.target.classList.add('dragging');
                });
                item.addEventListener('dragend', (e) => e.target.classList.remove('dragging'));
                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    if (draggedResultItem !== e.target) e.target.classList.add('drag-over-swap');
                });
                item.addEventListener('dragleave', (e) => e.target.classList.remove('drag-over-swap'));
                item.addEventListener('drop', (e) => {
                    e.preventDefault();
                    e.target.classList.remove('drag-over-swap');
                    if (draggedResultItem !== e.target) {
                        const draggedName = draggedResultItem.textContent;
                        const draggedStyle = draggedResultItem.style.cssText;
                        const draggedRole = draggedResultItem.dataset.role;
                        draggedResultItem.textContent = e.target.textContent;
                        draggedResultItem.style.cssText = e.target.style.cssText;
                        draggedResultItem.dataset.role = e.target.dataset.role;
                        e.target.textContent = draggedName;
                        e.target.style.cssText = draggedStyle;
                        e.target.dataset.role = draggedRole;
                    }
                });
            });
        }
        
        function initializeTimeSelect() {
            const now = new Date();
            document.getElementById('battle-date').value = now.toISOString().split('T')[0];
            battleTimeSelect.innerHTML = '';
            for (let h = 0; h < 24; h++) {
                for (let m = 0; m < 60; m += 30) {
                    const timeString = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
                    const option = document.createElement('option');
                    option.value = timeString;
                    option.textContent = timeString;
                    battleTimeSelect.appendChild(option);
                }
            }
            let currentHour = now.getHours();
            let currentMinute = now.getMinutes();
            if (currentMinute < 15) currentMinute = 0;
            else if (currentMinute < 45) currentMinute = 30;
            else { currentMinute = 0; currentHour = (currentHour + 1) % 24; }
            battleTimeSelect.value = `${currentHour.toString().padStart(2, '0')}:${currentMinute.toString().padStart(2, '0')}`;
        }
    </script>
</body>
</html>